---
- name: "Create tmp directory"
  file:
    path: "{{ tmp_dir }}"
    state: directory
    mode: 0755
  tags: helm

- name: "Check if Helm is installed"
  shell: command -v helm >/dev/null 2>&1
  register: helm_exists
  ignore_errors: yes
  tags: helm

- name: "Install Helm"
  block:
    - name: "Get Helm installer"
      get_url:
        url: https://azol-os-repo.simbrella.pro:9443/sre-repo/Packages/helm-{{ helm_version }}-linux-amd64.tar.gz
        dest: "{{ tmp_dir }}/helm-{{ helm_version }}-linux-amd64.tar.gz"

    - name: Extract helm-{{ helm_version }}-linux-amd64.tar.gz
      ansible.builtin.unarchive:
        src: helm-{{ helm_version }}-linux-amd64.tar.gz
        creates: "helm-{{helm_version}}"
        dest: "{{ tmp_dir }}"
        remote_src: yes

  when: helm_exists.rc > 0
  tags: helm

- name: Move Helm binary it to its desired destination
  ansible.builtin.copy:
    src: "{{ tmp_dir }}/helm-{{helm_version}}/helm"
    dest: /usr/local/bin/helm

- name: Add Azol Helm charts repository
  kubernetes.core.helm_repository:
    name: azol-chartrepo
    repo_url: https://azol-harbor.simbrella.pro/chartrepo/azol-chartrepo

- name: "Clean-up"
  file:
    path: "{{ tmp_dir }}"
    state: absent
  ignore_errors: yes
  tags: helm
